version: "3.8"

services:

    # -- Main Services
    proxy:
        image: caddy:alpine
        container_name: proxy
        restart: unless-stopped
        env_file:
            - "./.env"
        ports:
            - "80:80"
            - "443:443"
            - "443:443/udp"
            - "7080:7080" # Adminer
            - "7081:7081" # File Browser
        volumes:
            - "${DATA_DIR}/caddy/data:/data"
            - "${DATA_DIR}/caddy/config:/config"
            - "./assets/Caddyfile:/etc/caddy/Caddyfile"
            - "${DATA_DIR}/caddy/certificate-authority:/data/caddy/pki/authorities/local"
            - "./assets/caddy-entrypoint.sh:/usr/local/bin/caddy-entrypoint.sh"
        entrypoint: [sh, "-c", "chmod +x /usr/local/bin/caddy-entrypoint.sh && /usr/local/bin/caddy-entrypoint.sh"]
        networks:
            - default

    db:
        image: mariadb:latest
        container_name: mariadb
        restart: unless-stopped
        env_file:
            - "./.env"
        volumes:
            - "${DATA_DIR}/mysql:/var/lib/mysql"
        networks:
            - default

    app:
        # Uncomment the following lines to build the image from a Dockerfile
        # instead of pulling from a registry.
        # build:
        #     context: .
        #     args:
        #         HOSTNAME: ${HOSTNAME}
        #         PHP_VERSION: ${PHP_VERSION:-8.4-fpm}
        image: "rafaeloliveirax/apache-php${PHP_VERSION:-8.4-fpm}:latest"
        container_name: app
        restart: unless-stopped
        env_file:
            - "./.env"
        volumes:
            - "${WEB_DIR}:/var/www/html"
            - "${DATA_DIR}/logs/apache2:/var/log/apache2"
        networks:
            - default

    # -- Management Tools

    dbadmin:
        image: adminer
        container_name: dbadmin
        restart: unless-stopped
        profiles:
            - admin

    filemanager:
        image: filegator/filegator
        container_name: filemanager
        restart: unless-stopped
        volumes:
            - "${WEB_DIR}:/var/www/filegator/repository"
        profiles:
            - admin

networks:
    default:
        external: false