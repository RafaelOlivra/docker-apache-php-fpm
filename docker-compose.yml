version: "3.8"

services:

    # -- Main Services
    proxy:
        image: caddy:alpine
        container_name: proxy
        restart: unless-stopped
        env_file:
            - "./.env"
        ports:
            - "80:80"
            - "443:443"
            - "443:443/udp"
        volumes:
            - "${DATA_DIR}/caddy/data:/data"
            - "${DATA_DIR}/caddy/config:/config"
            - "./assets/Caddyfile:/etc/caddy/Caddyfile"
            - "${DATA_DIR}/caddy/certificate-authority:/data/caddy/pki/authorities/local"
        networks:
            - default

    db:
        image: mariadb:latest
        container_name: mariadb
        restart: unless-stopped
        env_file:
            - "./.env"
        environment:
            MARIADB_DATABASE: "${PROD_MARIADB_DATABASE}"
            MARIADB_USER: "${PROD_MARIADB_USER}"
            MARIADB_PASSWORD: "${PROD_MARIADB_PASSWORD}"
            MARIADB_ROOT_PASSWORD: "${PROD_MARIADB_ROOT_PASSWORD}"
        volumes:
            - "${DATA_DIR}/mysql:/var/lib/mysql"
        networks:
            - default

    app:
        # Uncomment the following lines to build the image from a Dockerfile
        # instead of pulling from a registry.
        # build:
        #     context: .
        #     args:
        #         HOSTNAME: ${HOSTNAME}
        #         PHP_VERSION: ${PHP_VERSION:-8.4-fpm}
        image: "rafaeloliveirax/apache-php${PHP_VERSION:-8.4-fpm}:latest"
        container_name: app
        restart: unless-stopped
        env_file:
            - "./.env"
        volumes:
            - "${WEB_DIR}:/var/www/html"
            - "${DATA_DIR}/logs/apache2:/var/log/apache2"
        networks:
            - default

    # -- Management Utils

    filebrowser:
        image: filebrowser/filebrowser:latest
        container_name: filebrowser
        restart: unless-stopped
        volumes:
            - "${WEB_DIR}:/srv"
            - "${DATA_DIR}/filebrowser:/database"
        env_file:
            - "./.env"
        environment:
            - FB_BASEURL=/adm/filebrowser/
        profiles:
            - ${ADMIN_TOOLS_PROFILE:-donotstart}
        networks:
            - default

    dbadmin:
        image: phpmyadmin:latest
        container_name: dbadmin
        restart: "no"
        environment:
            - PMA_ARBITRARY=1
        profiles:
            - ${ADMIN_TOOLS_PROFILE:-donotstart}
        networks:
            - default

networks:
    default:
        external: false
